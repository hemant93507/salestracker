<template>
  <div class="page">
    <div class="navbar navbar-main bg-color-white color-green">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link icon-only panel-open" data-panel="left">
            <i class="icon material-icons">menu</i>
          </a>
        </div>
        <div class="title">Dashboard</div>
        <div class="right">
          <a href="#" data-popover=".dashboard-popover" class="popover-open link icon-only">
            <i class="icon material-icons">more_vert</i>
          </a>
        </div>
      </div>
    </div>
    <div class="popover dashboard-popover">
      <div class="popover-inner">
        <div class="list">
          <ul>
            <li><a class="color-black list-button item-link popover-close" href="#" onclick="shareApp()">Share App</a>
            </li>
            <li><a @click="logout" class="color-black list-button item-link popover-close" href="#">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="sheet-modal my-sheet">
      <div class="toolbar">
        <div class="toolbar-inner">
          <div class="left"></div>
          <div class="right">
            <a href="#" class="link sheet-close">Done</a>
          </div>
        </div>
      </div>
      <div class="sheet-modal-inner">
        <div class="block">
          <div class="list">
            <ul>
              <li>
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Check In</div>
                    <div class="item-after">{{CheckIn}}</div>
                  </div>
                </div>
              </li>
              <li>
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Duration</div>
                    <div class="item-after">{{TimeSpentToday}}</div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="page-content">
      <div class="block">
        <div class="list no-hairlines">
          <ul>
            <li>
              <a href="#" class="item-link item-content">
                <div class="item-inner">
                  <div class="item-title">Client Visit Today</div>
                  <div class="item-after">{{ClientVisitToday}}</div>
                </div>
              </a>
            </li>
            <li>
              <a href="#" class="item-link item-content{{SheetOpen}}" data-sheet=".my-sheet">
                <div class="item-inner">
                  <div class="item-title">Time Spent Today</div>
                  <div class="item-after">{{TimeSpentToday}}</div>
                </div>
              </a>
            </li>
          </ul>
        </div>
        <div class="block text-align-center">
          <div class="row">
            <div class="col-50">
              <button @click="{{checkin_event}}" class="button button-round button-outline">{{checkin_text}}</button>
            </div>
            <div class="col-50">
              <a href="/client-visit/" class="button button-round button-outline">Client Visit</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
  return {
    data: function () {
      return {
        checkin_event: 'checkin',
        checkin_text: 'Check In',
      }
    },
    on: {
      pageInit: function () {
        $$('.employees-menu').hide();
        //$$('.clientvisit-menu,.attendance-menu').show();
        $$('.panel-left .attendance-menu a').attr('href', '/attendance/');
        $$('.panel-left .clientvisit-menu a').attr('href', '/client-visit/');
        var self = this;
        var checkin_event = 'checkin';
        var checkin_text = 'Check In';
        var SheetOpen = '';
        var data = JSON.parse(localStorage.User);
        var obj = {
          email: data.User.email,
        };
        app.request({
          url: BaseURL + 'user-dashboard',
          method: 'POST',
          dataType: 'json',
          data: obj,
          //contentType: 'application/json',
          success: function (data, status, xhr) {
            console.log(data);
            if (data.ErrorCode == '0') {
              if (data.CheckedIn == true) {
                checkin_event = 'checkout';
                checkin_text = 'Check Out';
                SheetOpen = ' sheet-open';
              }
              self.$setState({
                CheckIn: data.CheckIn,
                CheckOut: data.CheckOut,
                TimeSpentToday: data.TimeSpentToday,
                ClientVisitToday: data.ClientVisitToday,
                checkin_event: checkin_event,
                checkin_text: checkin_text,
                SheetOpen: SheetOpen,
              });
            }
          },
        })
      }
    },
    methods: {
      // checkin: function () {
      //   app.preloader.show();
      //   var self = this;
      //   var data = JSON.parse(localStorage.User);
      //   var options = {
      //     timeout: 5000,
      //     maximumAge: 3000
      //   }
      //   function onSuccess(position) {
      //     var latitude = position.coords.latitude;
      //     var longitude = position.coords.longitude;
      //     function locationFromLatLon_success(result) {
      //       var firstResult = result[0];
      //       var location = firstResult.subLocality + ', ' + firstResult.locality + ', ' + firstResult.administrativeArea;
      //       var obj = {
      //         email: data.User.email,
      //         latitude: latitude,
      //         longitude: longitude,
      //         location: location,
      //       };
      //       app.request({
      //         url: BaseURL + 'checkin',
      //         method: 'POST',
      //         dataType: 'json',
      //         data: obj,
      //         //contentType: 'application/json',
      //         error: function (xhr, status) {
      //           alert(statusMessage(status));
      //         },
      //         success: function (data, status, xhr) {
      //           console.log(data);
      //           if (data.ErrorCode == '0') {
      //             self.$setState({
      //               checkin_event: 'checkout',
      //               checkin_text: 'Check Out',
      //             });
      //             window.plugins.toast.show(data.ErrorMessage, 'long', 'bottom');
      //           }
      //           else {
      //             app.dialog.alert(data.ErrorMessage);
      //           }
      //         },
      //         complete: function (xhr, status) {
      //           app.preloader.hide();
      //         }
      //       })
      //     }
      //     function locationFromLatLon_failure(err) {
      //       app.preloader.hide();
      //     }
      //     nativegeocoder.reverseGeocode(locationFromLatLon_success, locationFromLatLon_failure, latitude, longitude, { useLocale: true, maxResults: 1 });
      //   };
      //   function onError(error) {
      //     app.preloader.hide();
      //   }

      //   navigator.geolocation.getCurrentPosition(onSuccess, onError, options);

      // },
      checkin: function () {
        var self = this;
        var data = JSON.parse(localStorage.User);
        // Geolocation options
        var options = {
          timeout: 5000,
          maximumAge: 3000
        }
        // After Allow
        function onSuccess(position) {
          cordova.plugins.locationAccuracy.request(function (success) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
          }, function (error) {
            console.log("No Thanks");
          }, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);
        };
        // After Deny
        function onError(error) {
          //app.preloader.hide();
        }

        // navigator.geolocation.getCurrentPosition(onSuccess, onError, options);

        cordova.plugins.locationAccuracy.canRequest(function (canRequest) {
          if (canRequest) {
            cordova.plugins.locationAccuracy.request(function (success) {
              self.checkinUpdate1(); // Permission given but location OFF
            }, function (error) {
              console.log("No Thanks");
            }, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);
          } else {
            self.checkinUpdate2(); // Permission not given
          }
        });

      },
      checkout: function () {
        app.preloader.show();
        var self = this;
        var data = JSON.parse(localStorage.User);
        var obj = {
          email: data.User.email,
        };
        app.request({
          url: BaseURL + 'checkout',
          method: 'POST',
          dataType: 'json',
          data: obj,
          //contentType: 'application/json',
          error: function (xhr, status) {
            alert(statusMessage(status));
          },
          success: function (data, status, xhr) {
            console.log(data);
            if (data.ErrorCode == '0') {
              self.$setState({
                checkin_event: 'checkin',
                checkin_text: 'Check In',
              });
              window.plugins.toast.show(data.ErrorMessage, 'long', 'bottom');
            }
            else {
              app.dialog.alert(data.ErrorMessage);
            }
          },
          complete: function (xhr, status) {
            app.preloader.hide();
          }
        })
      },
      checkinUpdate1: function () {
        cordova.plugins.locationAccuracy.request(function (success) {
          navigator.geolocation.getCurrentPosition(function (position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            alert(latitude);
          }, function (error) {
            console.log(error);
          },
          {
            timeout: 5000,
            maximumAge: 3000
          });
        }, function (error) {
          console.log("No Thanks");
        }, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);
      },
      checkinUpdate2: function () {
        alert('Permission not given');
        // navigator.geolocation.getCurrentPosition(function (position) {
        //   cordova.plugins.locationAccuracy.request(function (success) {
        //     var latitude = position.coords.latitude;
        //     var longitude = position.coords.longitude;
        //     alert(latitude);
        //   }, function (error) {
        //     console.log("No Thanks");
        //   }, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);
        // }, function (error) {
        //   console.log(error);
        // },
        // {
        //   timeout: 5000,
        //   maximumAge: 3000
        // });
      },
      logout: function () {
        localStorage.removeItem("User");
        app.views.main.router.navigate('/');
      }
    },
  }
</script>