<template>
  <div class="page" id="attendance-page">
    <div class="navbar">
      <div class="navbar-inner sliding bg-color-white color-green">
        <div class="left">
          <a href="#" class="link back">
            <i class="material-icons">arrow_back</i>
          </a>
        </div>
        <div class="title">Add Client</div>
      </div>
    </div>
    <div class="page-content">
      <form class="list no-hairlines margin" id="clientvisit-form">
        <ul class="no-hairlines-between">
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-floating-label">*Party Name</div>
              <div class="item-input-wrap">
                <input type="text" name="party_name" required validate>
              </div>
            </div>
          </li>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-floating-label">*Party Email</div>
              <div class="item-input-wrap">
                <input type="email" name="party_email" required validate>
              </div>
            </div>
          </li>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-floating-label">*Party Phone</div>
              <div class="item-input-wrap">
                <input type="tel" name="party_phone" required validate>
              </div>
            </div>
          </li>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-floating-label">*Party Address</div>
              <div class="item-input-wrap">
                <textarea name="party_address" class="resizable" placeholder="Party Address" required
                  validate></textarea>
              </div>
            </div>
          </li>
          <li class="item-content item-input">
            <div class="item-inner margin-top">
              <img @click="locationImage" id="locationImage" src="img/upload.png"
                style="width: 50px;height: 60px;vertical-align: middle;" />
              Upload Location Photo
            </div>
          </li>
        </ul>
        <a href="#" @click="addClient" class="button button-outline button-round margin">Submit</a>
      </form>
    </div>
  </div>
</template>
<script>
  var location_image = '';
  return {
    on: {
      pageInit: function () {

      }
    },
    methods: {
      addClient: function () {
        var self = this;
        var data = JSON.parse(localStorage.User);
        var options = {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 3000
        }
        function onSuccess(position) {
          var latitude = position.coords.latitude;
          var longitude = position.coords.longitude;
          var party_name = $$('#clientvisit-form input[name=party_name]').val();
          var party_email = $$('#clientvisit-form input[name=party_email]').val();
          var party_phone = $$('#clientvisit-form input[name=party_phone]').val();
          var party_address = $$('#clientvisit-form textarea[name=party_address]').val();
          var obj = {
            email: data.User.email,
            latitude: latitude,
            longitude: longitude,
            party_name: party_name,
            party_email: party_email,
            party_phone: party_phone,
            party_address: party_address,
            location_image: location_image,
          };
          app.request({
            url: BaseURL + 'add-clientvisit',
            method: 'POST',
            dataType: 'json',
            data: obj,
            //contentType: 'application/json',
            beforeSend: function (xhr) {
              app.preloader.show();
            },
            error: function (xhr, status) {
              alert(statusMessage(status));
            },
            success: function (data, status, xhr) {
              console.log(data);
              if (data.ErrorCode == '0') {
                app.dialog.alert('Record added successfully', function () {
                  app.views.main.router.navigate('/client-visit/');
                });
              }
              else {
                window.plugins.toast.show(data.ErrorMessage, 'long', 'bottom');
              }
            },
            complete: function (xhr, status) {
              app.preloader.hide();
            }
          })
        };
        function onError(error) {
          console.log(error);
        }
        if ($$('#clientvisit-form')[0].checkValidity()) {
          navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
        }
      },
      locationImage: function () {
        navigator.camera.getPicture(onSuccess, onFail, {
          quality: 100,
          targetWidth: 512,
          targetHeight: 512,
          correctOrientation: true,
          destinationType: Camera.DestinationType.DATA_URL,
        });
        function onSuccess(imageData) {
          var image = document.getElementById('locationImage');
          image.src = "data:image/jpeg;base64," + imageData;
          profile_image = "data:image/jpeg;base64," + imageData;
        }
        function onFail(message) {
          console.log(message);
        }
      }
    },
  }
</script>